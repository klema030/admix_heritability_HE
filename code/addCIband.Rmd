---
title: "addCItofigs"
author: "Jinguo Huang"
date: "2024-02-01, edited 02-13-24 (NK)"
output: html_document
---

Fig4 and Fig5 for GCTA results are average of 10 replicates, we'll add CI band for each of them by bootstrapping 100x. \# dummy dataset

```{r}
toy=dat[dat$P==0 & dat$t==0 & dat$cov=="pos" ,]
library(dplyr)
boot=tibble(num = 1:100) %>% 
  group_by(num) %>% 
  mutate(mean = mean(sample(toy$vg_gcta, 
                            replace = TRUE))) 
boot_mean=mean(boot$mean)
# Bootstrap 95% percentile confidence interval
boot_CI=quantile(boot$mean, c(0.025,0.975))
# report the mean and CI95%
mean_CIs=tibble(
  vg=boot_mean,
  CI95l=boot_CI[1],
  CI95r=boot_CI[2])
```

# function to bootstrap to get upper and lower end of CI

```{r}
# function to bootstrap: return to mean, CI95l, CI95r
meanCI <- function(data){
  library(dplyr)
  # Resample 100 times, and find the mean of each
  boot=tibble(num = 1:100) %>% 
    group_by(num) %>% 
    mutate(mean = mean(sample(data, 
                              replace = TRUE))) 
  boot_mean=mean(boot$mean)
  # Bootstrap 95% percentile confidence interval
  boot_CI=quantile(boot$mean, c(0.025,0.975))
  # report the mean and CI95%
  mean_CIs=tibble(
    mean=boot_mean,
    CI95l=boot_CI[1],
    CI95r=boot_CI[2])  
  return(mean_CIs)  
}

#meanCI(toy$vg_gcta)

# function to get mean and CIs for each rep
getmeanCI <- function(mydata){
  library(dplyr)
  mydata %>% 
   group_by(t, P, cov) %>% 
   summarise_at(vars("vg_GRMvarX_ganc", "vg_GRMvarX_noa", "vg_GRMvarX_gcta", "vg_GRMld_ganc", "vg_GRMld_noa", "vg_GRMvarX_gcta"), meanCI)}


filename="admix_CGF_theta0.5_gen20_grms.txt"
dat=read.table(filename, header=T)
df_CGF=getmeanCI(dat)

filename="admix_HI_theta0.5_gen20_grms.txt"
dat=read.table(filename, header=T)
df_HI=getmeanCI(dat)

# OUTPUT THE FILE
write.table(df_HI, file="admix_HI_HE_vg_grms_CI.txt",
            quote = FALSE, sep = "\t",
            row.names = FALSE, col.names = TRUE)
write.table(df_CGF, file="admix_CGF_HE_vg_grms_CI.txt",
            quote = FALSE, sep = "\t",
            row.names = FALSE, col.names = TRUE)
# THESE CONTAIN P=0.3, 0.6 AS WELL

```

#Remove P at 0.3 and 0.6 for HE regression and combine files (main and CI)

```{r}
#load CI files
HI_HE_CI = read.table("admix_HI_HE_vg_CI.txt", header = TRUE)
CGF_HE_CI = read.table("admix_CGF_HE_vg_CI.txt", header = TRUE)

#Remove P at 0.3 and 0.6 for plotting
CGF_HE_CI = CGF_HE_CI[!(CGF_HE_CI$P %in% 0.3),]
CGF_HE_CI = CGF_HE_CI[!(CGF_HE_CI$P %in% 0.6),]

HI_HE_CI = HI_HE_CI[!(HI_HE_CI$P %in% 0.3),]
HI_HE_CI = HI_HE_CI[!(HI_HE_CI$P %in% 0.6),]

#order to add main file
CGF_HE_CI = CGF_HE_CI[order(CGF_HE_CI$cov, CGF_HE_CI$t),]
HI_HE_CI = HI_HE_CI[order(HI_HE_CI$cov, HI_HE_CI$t),]

#add zero main file into CI file
CGF_zero_main = read.table("HEreg_CGF_zero_main.txt", header = T)
HI_zero_main = read.table("HEreg_HI_zero_main.txt", header = T)

#Remove P at 0.3 and 0.6 for plotting
CGF_zero_main = CGF_zero_main[!(CGF_zero_main$P %in% 0.3),]
CGF_zero_main = CGF_zero_main[!(CGF_zero_main$P %in% 0.6),]

HI_zero_main = HI_zero_main[!(HI_zero_main$P %in% 0.3),]
HI_zero_main = HI_zero_main[!(HI_zero_main$P %in% 0.6),]

#reorder to match CI
CGF_zero_main =CGF_zero_main[order(CGF_zero_main$cov, CGF_zero_main$t),]
HI_zero_main = HI_zero_main[order(HI_zero_main$cov, HI_zero_main$t),]

HEreg_CGF_CI = HEreg_CGF_CI[order(HEreg_CGF_CI$cov, HEreg_CGF_CI$t),]
HEreg_HI_CI = HEreg_HI_CI[order(HEreg_HI_CI$cov, HEreg_HI_CI$t),]

#combine pos, neg, and zero covs
CGF_vg_mat = as.data.table(matrix(data = NA, nrow = 84, ncol = 1))
HI_vg_mat = as.data.table(matrix(data = NA, nrow = 84, ncol = 1))

CGF_vg_mat$exp.vg = HEreg_CGF_CI$exp.vg
CGF_vg_mat$va.term1 = HEreg_CGF_CI$va.term1
CGF_vg_mat$va.term2 = HEreg_CGF_CI$va.term2
CGF_vg_mat$va.term3 = HEreg_CGF_CI$va.term3
CGF_vg_mat$va.term4 = HEreg_CGF_CI$va.term4

HI_vg_mat$exp.vg = HEreg_HI_CI$exp.vg
HI_vg_mat$va.term1 = HEreg_HI_CI$va.term1
HI_vg_mat$va.term2 = HEreg_HI_CI$va.term2
HI_vg_mat$va.term3 = HEreg_HI_CI$va.term3
HI_vg_mat$va.term4 = HEreg_HI_CI$va.term4

CGF_vg_mat = subset(CGF_vg_mat, select = -c(V1))
HI_vg_mat = subset(HI_vg_mat, select = -c(V1))

#for zeros main vg
CGF_vg_mat_zero = as.data.table(matrix(data = NA, nrow = 42, ncol = 1))
HI_vg_mat_zero = as.data.table(matrix(data = NA, nrow = 42, ncol = 1))

CGF_vg_mat_zero$exp.vg = CGF_zero_main$vg.sum
CGF_vg_mat_zero$va.term1 = CGF_zero_main$vg.term1
CGF_vg_mat_zero$va.term2 = CGF_zero_main$vg.term2
CGF_vg_mat_zero$va.term3 = CGF_zero_main$vg.term3
CGF_vg_mat_zero$va.term4 = CGF_zero_main$vg.term4

HI_vg_mat_zero$exp.vg = HI_zero_main$vg.sum
HI_vg_mat_zero$va.term1 = HI_zero_main$vg.term1
HI_vg_mat_zero$va.term2 = HI_zero_main$vg.term2
HI_vg_mat_zero$va.term3 = HI_zero_main$vg.term3
HI_vg_mat_zero$va.term4 = HI_zero_main$vg.term4

CGF_vg_mat_zero = subset(CGF_vg_mat_zero, select = -c(V1))
HI_vg_mat_zero = subset(HI_vg_mat_zero, select = -c(V1))

CGF_vg = rbind(CGF_vg_mat, CGF_vg_mat_zero)
HI_vg = rbind(HI_vg_mat, HI_vg_mat_zero)

#add vg to CI files
CGF_HE_CI$exp.vg = CGF_vg$exp.vg
CGF_HE_CI$va.term1 = CGF_vg$va.term1
CGF_HE_CI$va.term2 = CGF_vg$va.term2
CGF_HE_CI$va.term3 = CGF_vg$va.term3
CGF_HE_CI$va.term4 = CGF_vg$va.term4

HI_HE_CI$exp.vg = HI_vg$exp.vg
HI_HE_CI$va.term1 = HI_vg$va.term1
HI_HE_CI$va.term2 = HI_vg$va.term2
HI_HE_CI$va.term3 = HI_vg$va.term3
HI_HE_CI$va.term4 = HI_vg$va.term4

#output files
write.table(HI_HE_CI, file="admix_HI_HE_vg_CI_P0_P9_cov.txt",
            quote = FALSE, sep = "\t",
            row.names = FALSE, col.names = TRUE)
write.table(CGF_HE_CI, file="admix_CGF_HE_vg_CI_P0_P9_cov.txt",
            quote = FALSE, sep = "\t",
            row.names = FALSE, col.names = TRUE)

#output files without zeros
CGF_HE_CI = CGF_HE_CI[!(CGF_HE_CI$cov %in% "zero"),]

HI_HE_CI = HI_HE_CI[!(HI_HE_CI$cov %in% "zero"),]

write.table(HI_HE_CI, file="admix_HI_HE_vg_CI_P0_P9_posneg.txt",
            quote = FALSE, sep = "\t",
            row.names = FALSE, col.names = TRUE)
write.table(CGF_HE_CI, file="admix_CGF_HE_vg_CI_P0_P9_posneg.txt",
            quote = FALSE, sep = "\t",
            row.names = FALSE, col.names = TRUE)


#combine CI files with expected values from main file
CGF_CI_pn = read.table("admix_CGF_HE_vg_CI_P0_P9_posneg.txt", header = T)
HI_CI_pn = read.table("admix_HI_HE_vg_CI_P0_P9_posneg.txt", header = T)

HEreg_CGF_CI = read.table("HEreg_CGF.txt", header = T)
HEreg_HI_CI = read.table("HEreg_HI.txt", header = T)

#Remove P at 0.3 and 0.6 for plotting
HEreg_CGF_CI = HEreg_CGF_CI[!(HEreg_CGF_CI$P %in% 0.3),]
HEreg_CGF_CI = HEreg_CGF_CI[!(HEreg_CGF_CI$P %in% 0.6),]

HEreg_HI_CI = HEreg_HI_CI[!(HEreg_HI_CI$P %in% 0.3),]
HEreg_HI_CI = HEreg_HI_CI[!(HEreg_HI_CI$P %in% 0.6),]

CGF_CI_pn$exp.vg = HEreg_CGF_CI$exp.vg
CGF_CI_pn$va.term1 = HEreg_CGF_CI$va.term1
CGF_CI_pn$va.term2 = HEreg_CGF_CI$va.term2
CGF_CI_pn$va.term3 = HEreg_CGF_CI$va.term3
CGF_CI_pn$va.term4 = HEreg_CGF_CI$va.term4

HI_CI_pn$exp.vg = HEreg_HI_CI$exp.vg
HI_CI_pn$va.term1 = HEreg_HI_CI$va.term1
HI_CI_pn$va.term2 = HEreg_HI_CI$va.term2
HI_CI_pn$va.term3 = HEreg_HI_CI$va.term3
HI_CI_pn$va.term4 = HEreg_HI_CI$va.term4

write.table(HI_CI_pn, file="admix_HI_HE_vg_CI_P0_P9_posneg.txt",
            quote = FALSE, sep = "\t",
            row.names = FALSE, col.names = TRUE)
write.table(CGF_CI_pn, file="admix_CGF_HE_vg_CI_P0_P9_posneg.txt",
            quote = FALSE, sep = "\t",
            row.names = FALSE, col.names = TRUE)

```

# Combine Scaled GRMs with CI_posneg file

```{r}
#load CI_posneg file
CGF_CI_pn = read.table("admix_CGF_HE_vg_CI_P0_P9_posneg.txt", header = T)
HI_CI_pn = read.table("admix_HI_HE_vg_CI_P0_P9_posneg.txt", header = T)

#load Scaled GRMs CI
CGF_grms = read.table("admix_CGF_HE_vg_grms_CI.txt", header = T)
HI_grms = read.table("admix_HI_HE_vg_grms_CI.txt", header = T)

#remove P=0.3, 0.6 for scaled grms
CGF_grms = CGF_grms[!(CGF_grms$P %in% 0.3),]
CGF_grms = CGF_grms[!(CGF_grms$P %in% 0.6),]

HI_grms = HI_grms[!(HI_grms$P %in% 0.3),]
HI_grms = HI_grms[!(HI_grms$P %in% 0.6),]

#combine files
CGF_CI_grms = merge(CGF_CI_pn, CGF_grms, by=c("t", "P", "cov"))
HI_CI_grms = merge(HI_CI_pn, HI_grms, by=c("t", "P", "cov"))

#output main figure 4 file
write.table(CGF_CI_grms, file="admix_CGF_HE_vg_CI_P0_P9_posneg_grms.txt",
            quote = FALSE, sep = "\t",
            row.names = FALSE, col.names = TRUE)
write.table(HI_CI_grms, file="admix_HI_HE_vg_CI_P0_P9_posneg_grms.txt",
            quote = FALSE, sep = "\t",
            row.names = FALSE, col.names = TRUE)

```

# get mean and CI for h2

```{r}
getmeanCI_h2 <- function(mydata){
  library(dplyr)
  mydata %>% 
   group_by(t, P, cov) %>% 
   summarise_at(vars("h2_GRMstd", "h2_GRMvarx", "h2_GRMld", "h2_GRMstd_ganc", "h2_GRMvarx_ganc","h2_GRMld_ganc"), meanCI)}

filename="admix_CGF_theta0.5_gen20_seed1-10.summary_GRM3casesh2.txt"
dat=read.table(filename, header=T)
df_CGF_h2=getmeanCI_h2(dat)

filename="admix_HI_theta0.5_gen20_seed1-10.summary_GRM3casesh2.txt"
dat=read.table(filename, header=T)
df_HI_h2=getmeanCI_h2(dat)

# OUTPUT THE FILE
write.table(df_HI_h2, file="admix_HI_GREML_h2_CI.txt",
            quote = FALSE, sep = "\t",
            row.names = FALSE, col.names = TRUE)
write.table(df_CGF_h2, file="admix_CGF_GREML_h2_CI.txt",
            quote = FALSE, sep = "\t",
            row.names = FALSE, col.names = TRUE)

```

# get mean and CI for h2

```{r}
getmeanCI_ve <- function(mydata){
  library(dplyr)
  mydata %>% 
   group_by(t, P, cov) %>% 
   summarise_at(vars("ve_GRMstd", "ve_GRMvarx", "ve_GRMld", "ve_GRMstd_ganc", "ve_GRMvarx_ganc","ve_GRMld_ganc"), meanCI)}

filename="admix_CGF_theta0.5_gen20_seed1-10.summary_GRM3casesve.txt"
dat=read.table(filename, header=T)
df_CGF_ve=getmeanCI_ve(dat)

filename="admix_HI_theta0.5_gen20_seed1-10.summary_GRM3casesve.txt"
dat=read.table(filename, header=T)
df_HI_ve=getmeanCI_ve(dat)

# OUTPUT THE FILE
write.table(df_HI_ve, file="admix_HI_GREML_ve_CI.txt",
            quote = FALSE, sep = "\t",
            row.names = FALSE, col.names = TRUE)
write.table(df_CGF_ve, file="admix_CGF_GREML_ve_CI.txt",
            quote = FALSE, sep = "\t",
            row.names = FALSE, col.names = TRUE)

```

# combine with expected values and plot

```{r}

# combine vg, ve, h2
vg_ve_h2_CGF=merge(df_CGF, 
                   merge(df_CGF_ve, df_CGF_h2,
                   by = c("t", "P", "cov")),
                   by = c("t", "P", "cov")
                   )

vg_ve_h2_HI=merge(df_HI, 
                   merge(df_HI_ve, df_HI_h2,
                   by = c("t", "P", "cov")),
                   by = c("t", "P", "cov")
                   )

write.table(vg_ve_h2_HI, file="admix_HI_GREML_vgveh2_CI.txt",
            quote = FALSE, sep = "\t",
            row.names = FALSE, col.names = TRUE)
write.table(vg_ve_h2_CGF, file="admix_CGF_GREML_vgveh2_CI.txt",
            quote = FALSE, sep = "\t",
            row.names = FALSE, col.names = TRUE)

```

# combine with expected values

```{r}
exp_CGF=read.table("../step21_manuscript_plot/data/admix_CGF_GREML_vg.txt", header=T)
exp_HI=read.table("../step21_manuscript_plot/data/admix_HI_GREML_vg.txt", header=T)

df_HI_CI=merge(vg_ve_h2_HI, exp_HI,
                   by = c("t", "P", "cov"))
df_CGF_CI=merge(vg_ve_h2_CGF, exp_CGF,
                   by = c("t", "P", "cov"))

write.table(df_HI_CI, file="admix_HI_GREML_vgveh2_CI_exp.txt",
            quote = FALSE, sep = "\t",
            row.names = FALSE, col.names = TRUE)
write.table(df_CGF_CI, file="admix_CGF_GREML_vgveh2_CI_exp.txt",
            quote = FALSE, sep = "\t",
            row.names = FALSE, col.names = TRUE)
```

# read the file

```{r}
df_HI_CI=read.table(file="admix_HI_GREML_vgveh2_CI_exp.txt", header=T)
df_CGF_CI=read.table(file="admix_CGF_GREML_vgveh2_CI_exp.txt", header=T)
```

# plot with CI band

```{r}
# plot gcta estimate and expected 
fig4A=function(data, yobs, yexp, ylab, 
               CIl, CIr,
               legend.position="right"){
  library(ggplot2)
  ggplot() +
    geom_ribbon(data=data, alpha=0.2, linetype = 0, #remove the boarder
              aes(x=t, 
                  ymin = CIl, ymax = CIr,
                  group=interaction(P, cov),
                fill=interaction(P, cov))) +
  geom_line(data=data, linewidth=0.9, alpha = 0.65, #transparent this line
            aes(x=t, y = yobs,                               
                linetype = "obs",
                group=interaction(P, cov), 
                color=interaction(P, cov))) +
  geom_line(data=data, linewidth=0.9, 
            aes(x=t, y = yexp, 
                linetype = "exp",
                group=interaction(P, cov),
                color=interaction(P, cov))) +

  scale_y_log10(limits=c(0.9, 2.1)) +
  scale_linetype_manual("", 
                       breaks = c("obs",   "exp"),
                       values = c("solid",  "11"),
                       labels = c("Estimated\n(standard)",
                                  expression(V[g])
                                  )) +
  scale_colour_manual("", 
                      values = c('#92c5de','#053061',
                                 '#f4a582','#67001f') ,
                      labels = c("P=0", "P=0.9", 
                                 "P=0", "P=0.9"
                                 )) +
    scale_fill_manual("", 
                      values = c('#92c5de','#053061',
                                 '#f4a582','#67001f') ,
                      labels = c("P=0", "P=0.9", 
                                 "P=0", "P=0.9"
                                 )) +
  theme_classic() +
  xlab("t") +
  ylab(ylab)  + 
  theme(aspect.ratio = 1, 
        plot.title = element_text(hjust = 0.5), # to center the title
        legend.position = legend.position, 
        legend.text.align = 0, #left align legend
        text = element_text(size = 12),
        plot.margin = unit(c(0, 0, 0, 0), 'cm')
        ) + 
  guides(color = "none", fill = "none",# no show color legend
          linetype = guide_legend(order = 2, reverse = T)
         )
}

HIa_wo=fig4A(data=df_HI_CI, 
          yobs = df_HI_CI$vg_gcta.x.mean, 
          yexp = df_HI_CI$exp.vg,
          ylab = expression(hat(sigma)[u]^2),
          CIl = df_HI_CI$vg_gcta.x.CI95l,
          CIr = df_HI_CI$vg_gcta.x.CI95r,
          legend.position = "none") 
HIa_wo
CGFa_wo=fig4A(data=df_CGF_CI, 
          yobs = df_CGF_CI$vg_gcta.x.mean, 
          yexp = df_CGF_CI$exp.vg,
          ylab = expression(hat(sigma)[u]^2),
          CIl = df_CGF_CI$vg_gcta.x.CI95l,
          CIr = df_CGF_CI$vg_gcta.x.CI95r,
          legend.position = "right") 
CGFa_wo

HIa_wganc=fig4A(data=df_HI_CI, 
          yobs = df_HI_CI$vg_gcta_wganc.x.mean, 
          yexp = df_HI_CI$exp.vg,
          ylab = expression(hat(sigma)[u]^2),
          CIl = df_HI_CI$vg_gcta_wganc.x.CI95l,
          CIr = df_HI_CI$vg_gcta_wganc.x.CI95r,
          legend.position = "none") 

CGFa_wganc=fig4A(data=df_CGF_CI, 
          yobs = df_CGF_CI$vg_gcta_wganc.x.mean, 
          yexp = df_CGF_CI$exp.vg,
          ylab = expression(hat(sigma)[u]^2),
          CIl = df_CGF_CI$vg_gcta_wganc.x.CI95l,
          CIr = df_CGF_CI$vg_gcta_wganc.x.CI95r,
          legend.position = "right") 
```

```{r}

fig4A(data=df_HI_CI, 
          yobs = df_HI_CI$h2_GRMstd.mean, 
          yexp = 0.8,
          ylab = expression(h^2),
          CIl = df_HI_CI$h2_GRMstd.CI95l,
          CIr = df_HI_CI$h2_GRMstd.CI95r,
          legend.position = "none") 

fig4A(data=df_HI_CI, 
          yobs = df_HI_CI$ve_GRMstd.mean, 
          yexp = df_HI_CI$exp.vg/4,
          ylab = expression(V[e]),
          CIl = df_HI_CI$ve_GRMstd.CI95l,
          CIr = df_HI_CI$ve_GRMstd.CI95r,
          legend.position = "none") 

```

# fig 4b

```{r}
fig4B=function(data, yobs, CIl, CIr, legend.position="right"){
library(ggplot2)
ggplot() +
    geom_ribbon(data=data, alpha=0.2, linetype = 0,
              aes(x=t, 
                  ymin = CIl, ymax = CIr,
                  group=interaction(P, cov),
                fill=interaction(P, cov))) +
  geom_line(data=data, linewidth=0.9, color="black", 
            aes(x=t, y = va.term1+va.term2,
                linetype = "exp",
                group=interaction(P, cov)
                                     )) + 
  geom_line(data=data, linewidth=0.9, alpha = 0.65, #transparent this line
            aes(x=t, y = yobs,
                linetype = "obs",
                group=interaction(P, cov),
                color=interaction(P, cov))) +

   ylim(c(0.93, 1.01))+
  scale_linetype_manual("", 
                       breaks = c("obs",   "exp"),
                       values = c("solid",  "11"),
                       labels = c("Estimated\n(standard)",
                                  "(1.1)+(1.2)")) + 
  scale_colour_manual("", 
                      values = c('#92c5de','#053061',
                                 '#f4a582','#67001f') ,
                      labels = c("P=0", "P=0.9", 
                                 "P=0", "P=0.9"
                                 )) +
    scale_fill_manual("", 
                      values = c('#92c5de','#053061',
                                 '#f4a582','#67001f') ,
                      labels = c("P=0", "P=0.9", 
                                 "P=0", "P=0.9"
                                 )) +
  theme_classic() +
  xlab("t") +
  ylab(expression(hat(sigma)[u]^2))  + 
  theme(aspect.ratio = 1, 
        plot.title = element_text(hjust = 0.5), # to center the title
        legend.position = legend.position, 
        legend.text.align = 0, #left align legend
        text = element_text(size = 12),
        plot.margin = unit(c(0, 0, 0, 0), 'cm')
        ) + 
  guides(color = "none", fill = "none",
          linetype = guide_legend(order = 1, reverse = T
                              ) )}
HIb_wo=fig4B(data=df_HI_CI, 
             yobs = df_HI_CI$vg_gcta.x.mean,
             CIl = df_HI_CI$vg_gcta.x.CI95l,
             CIr = df_HI_CI$vg_gcta.x.CI95r,
             legend.position = "none")
HIb_wo


CGFb_wo=fig4B(data=df_CGF_CI, 
             yobs = df_CGF_CI$vg_gcta.x.mean,
             CIl = df_CGF_CI$vg_gcta.x.CI95l,
             CIr = df_CGF_CI$vg_gcta.x.CI95r,
             legend.position = "right")
CGFb_wo

HIb_wganc=fig4B(data=df_HI_CI, 
             yobs = df_HI_CI$vg_gcta_wganc.x.mean,
             CIl = df_HI_CI$vg_gcta_wganc.x.CI95l,
             CIr = df_HI_CI$vg_gcta_wganc.x.CI95r,
             legend.position = "none")
HIb_wganc
CGFb_wganc=fig4B(data=df_CGF_CI, 
             yobs = df_CGF_CI$vg_gcta_wganc.x.mean,
             CIl = df_CGF_CI$vg_gcta_wganc.x.CI95l,
             CIr = df_CGF_CI$vg_gcta_wganc.x.CI95r,
             legend.position = "right")
CGFb_wganc
```

# fig 4c

```{r}
fig4C=function(data, yobs, CIl, CIr, 
               legend.position="right", y0.9=1.05){
  library(ggplot2)
  ggplot() +
    geom_ribbon(data=data, alpha=0.2, linetype = 0,
              aes(x=t, 
                  ymin = CIl, ymax = CIr,
                  group=interaction(P, cov),
                fill=interaction(P, cov))) +
     geom_line(data=data, linewidth=0.9, color="black", 
            aes(x=t, y = va.term1+va.term2+va.term3, 
                linetype = "exp",
                group=interaction(P, cov)#,
                #color=interaction(P, cov)
                )) +
  geom_line(data=data, linewidth=0.9, alpha = 0.65, #transparent this line
            aes(x=t, y = yobs,                               
                linetype = "obs",
                group=interaction(P, cov), 
                color=interaction(P, cov))) +
 
    annotate(geom = "text", x=16, y=y0.9, label="P=0.9") +
    annotate(geom = "text", x=16, y=0.985, label="P=0") +
    ylim(c(0.93, 1.08))+
  scale_linetype_manual("", 
                       breaks = c("obs",   "exp"),
                       values = c("solid",  "11"),
                       labels = c("Estimated\n(V(x) scaled)",
                                  "(1.1)+(1.2)\n+(1.3)")) +
  scale_colour_manual("", 
                      values = c('#92c5de','#053061',
                                 '#f4a582','#67001f') ,
                     labels = c("P=0", "P=0.9", 
                                 "P=0", "P=0.9"
                                 )) +
    scale_fill_manual("", 
                      values = c('#92c5de','#053061',
                                 '#f4a582','#67001f') ,
                      labels = c("P=0", "P=0.9", 
                                 "P=0", "P=0.9"
                                 )) +
  theme_classic() +
  xlab("t") +
  ylab(expression(hat(sigma)[u]^2))  + 
  theme(aspect.ratio = 1, 
        plot.title = element_text(hjust = 0.5), # to center the title
        legend.position = legend.position, 
        legend.text.align = 0, #left align legend
        text = element_text(size = 12),
        plot.margin = unit(c(0, 0, 0, 0), 'cm')
        ) + 
  guides(color = "none", fill = "none", # no show color legend
          linetype = guide_legend(order = 2, reverse = T
                              ) )
}


HIc_wo=fig4C(data=df_HI_CI, 
          yobs = df_HI_CI$vg_GRMvarX.x.mean,
          CIl = df_HI_CI$vg_GRMvarX.x.CI95l,
          CIr = df_HI_CI$vg_GRMvarX.x.CI95r,
          legend.position = "none")
HIc_wo

CGFc_wo=fig4C(data=df_CGF_CI, 
          yobs = df_CGF_CI$vg_GRMvarX.x.mean,
          CIl = df_CGF_CI$vg_GRMvarX.x.CI95l,
          CIr = df_CGF_CI$vg_GRMvarX.x.CI95r,
          y0.9 = 1.06,
          legend.position = "right")
CGFc_wo

HIc_wganc=fig4C(data=df_HI_CI, 
          yobs = df_HI_CI$vg_GRMvarX_ganc.x.mean,
          CIl = df_HI_CI$vg_GRMvarX_ganc.x.CI95l,
          CIr = df_HI_CI$vg_GRMvarX_ganc.x.CI95r,
          legend.position = "none")
HIc_wganc


CGFc_wganc=fig4C(data=df_CGF_CI, 
          yobs = df_CGF_CI$vg_GRMvarX_ganc.x.mean,
          CIl = df_CGF_CI$vg_GRMvarX_ganc.x.CI95l,
          CIr = df_CGF_CI$vg_GRMvarX_ganc.x.CI95r,
          y0.9 = 1.06,
          legend.position = "right")
CGFc_wganc
```

#fig 4d

```{r}
# LD matrix scaled results panel D
fig4D=function(data, yobs, CIl, CIr, yexp, ylab, legend.position="right"){
  library(ggplot2)
  ggplot() +
  geom_ribbon(data=data, alpha=0.2, linetype = 0,
            aes(x=t, 
                ymin = CIl, ymax = CIr,
                group=interaction(P, cov),
              fill=interaction(P, cov))) +
  geom_line(data=data, linewidth=0.9, alpha = 0.65, #transparent this line
            aes(x=t, y = yobs,                               
                linetype = "obs",
                group=interaction(P, cov), 
                color=interaction(P, cov))) +
  geom_line(data=data, linewidth=0.9, 
            aes(x=t, y = yexp, 
                linetype = "exp",
                group=interaction(P, cov),
                color=interaction(P, cov))) +
  scale_y_log10(limits=c(0.9, 2.1)) +
  scale_linetype_manual("", 
                       breaks = c("obs",   "exp"),
                       values = c("solid",  "11"),
                       labels = c("Estimated\n(LD scaled)",
                                  #"Expected"
                                  expression(V[g])
                                  )) +
  scale_colour_manual("", 
                      values = c('#92c5de','#053061',
                                 '#f4a582','#67001f') ,
                      labels = c("P=0", "P=0.9", 
                                 "P=0", "P=0.9"
                                 )) +
  scale_fill_manual("", 
                      values = c('#92c5de','#053061',
                                 '#f4a582','#67001f') ,
                      labels = c("P=0", "P=0.9", 
                                 "P=0", "P=0.9"
                                 )) +
  theme_classic() +
  xlab("t") +
  ylab(ylab)  + 
  theme(aspect.ratio = 1, 
        plot.title = element_text(hjust = 0.5), # to center the title
        legend.position = legend.position, 
        legend.text.align = 0, #left align legend
        text = element_text(size = 12),
        plot.margin = unit(c(0, 0, 0, 0), 'cm')
        ) + 
  guides(color = "none", fill = "none",# no show color legend
          linetype = guide_legend(order = 2, reverse = T) 
         )
}



HId_wo=fig4D(data=df_HI_CI, 
          yobs = df_HI_CI$vg_GRMld.x.mean, 
          yexp = df_HI_CI$exp.vg,
          CIl = df_HI_CI$vg_GRMld.x.CI95l,
          CIr = df_HI_CI$vg_GRMld.x.CI95r,
          ylab = expression(hat(sigma)[u]^2),
          legend.position = "none") 
HId_wo
CGFd_wo=fig4D(data=df_CGF_CI, 
          yobs = df_CGF_CI$vg_GRMld.x.mean, 
          yexp = df_CGF_CI$exp.vg,
          CIl = df_CGF_CI$vg_GRMld.x.CI95l,
          CIr = df_CGF_CI$vg_GRMld.x.CI95r,
          ylab = expression(hat(sigma)[u]^2),
          legend.position = "right") 
CGFd_wo

```

# fig4d wganc

```{r}
fig4D_w=function(data, yobs, CIl, CIr, ylab, legend.position="right", y0.9=0.93){
  library(ggplot2)
  ggplot() +
  geom_ribbon(data=data, alpha=0.2, linetype = 0,
            aes(x=t, 
                ymin = CIl, ymax = CIr,
                group=interaction(P, cov),
              fill=interaction(P, cov))) +
  geom_line(data=data, linewidth=0.9, color="black", 
            aes(x=t, y = va.term1+va.term2-va.term3, 
                linetype = "exp",
                group=interaction(P, cov))) +
  geom_line(data=data, linewidth=0.9, alpha = 0.65, #transparent this line
            aes(x=t, y = yobs,                               
                linetype = "obs",
                group=interaction(P, cov), 
                color=interaction(P, cov))) +
    annotate(geom = "text", x=16, y=y0.9, label="P=0.9") +
    annotate(geom = "text", x=16, y=1.03, label="P=0") +
  scale_y_log10(limits=c(0.9, 1.1)) +
  scale_linetype_manual("", 
                       breaks = c("obs",   "exp"),
                       values = c("solid",  "11"),
                       labels = c("Estimated\n(LD scaled)",
                                  "(1.1)+(1.2)\n-(1.3)")) +
  scale_colour_manual("", 
                      values = c('#92c5de','#053061',
                                 '#f4a582','#67001f') ,
                     labels = c("P=0", "P=0.9", 
                                "P=0", "P=0.9"
                                 )) +
  scale_fill_manual("", 
                      values = c('#92c5de','#053061',
                                 '#f4a582','#67001f') ,
                      labels = c("P=0", "P=0.9", 
                                 "P=0", "P=0.9"
                                 )) +
  theme_classic() +
  xlab("t") +
  ylab(ylab)  + 
  #ggtitle(title) +
  theme(aspect.ratio = 1, 
        plot.title = element_text(hjust = 0.5), # to center the title
        legend.position = legend.position, 
        legend.text.align = 0, #left align legend
        text = element_text(size = 12),
        plot.margin = unit(c(0, 0, 0, 0), 'cm')
        ) + 
  guides(color = "none", fill = "none",# no show color legend
          linetype = guide_legend(order = 2, reverse = T)#, 
         )
}
HId_wganc=fig4D_w(data=df_HI_CI, 
          yobs = df_HI_CI$vg_GRMld_ganc.x.mean, 
          CIl = df_HI_CI$vg_GRMld_ganc.x.CI95l,
          CIr = df_HI_CI$vg_GRMld_ganc.x.CI95r,
          ylab = expression(hat(sigma)[u]^2),
          legend.position = "none", y0.9=0.95) 
HId_wganc 
CGFd_wganc=fig4D_w(data=df_CGF_CI, 
          yobs = df_CGF_CI$vg_GRMld_ganc.x.mean, 
          CIl = df_CGF_CI$vg_GRMld_ganc.x.CI95l,
          CIr = df_CGF_CI$vg_GRMld_ganc.x.CI95r,
          ylab = expression(hat(sigma)[u]^2),
          legend.position = "right") 
CGFd_wganc 


```
